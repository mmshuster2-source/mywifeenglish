<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Pilot: Tanya Edition v3</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; margin: 0; padding-top: 15px; box-sizing: border-box; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar { display: flex; justify-content: space-between; width: 90%; max-width: 400px; margin-bottom: 15px; align-items: center; }
        .mode-switch { background: #fff; padding: 5px; border-radius: 20px; display: flex; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .mode-btn { border: none; background: none; padding: 8px 12px; border-radius: 15px; cursor: pointer; font-size: 13px; opacity: 0.6; transition: 0.3s; }
        .mode-btn.active { background-color: #e3f2fd; color: #1565c0; font-weight: bold; opacity: 1; }
        .settings-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); width: 88%; max-width: 380px; text-align: center; transition: all 0.3s ease; position: relative; }
        
        .main-word { color: #333; font-size: 2.0rem; margin: 10px 0 5px 0; font-weight: bold; word-wrap: break-word; line-height: 1.1; }
        /* –°—Ç–∏–ª—å –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ */
        .transcription { color: #ff9800; font-size: 1.1rem; font-weight: 500; margin-bottom: 15px; min-height: 20px; font-style: italic; }
        .sub-word { color: #888; font-size: 1.2rem; margin-bottom: 20px; min-height: 24px; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { display: block; width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 12px; font-size: 1rem; cursor: pointer; transition: transform 0.1s; position: relative; }
        .btn:active { transform: scale(0.98); }
        .btn-listen { background-color: #e3f2fd; color: #1565c0; margin-bottom: 15px; font-weight: 600;}
        .btn-speak { background-color: #ffebee; color: #c62828; font-weight: bold; font-size: 1.3rem; padding: 15px; border-radius: 50px; width: 70px; height: 70px; margin: 0 auto; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(198, 40, 40, 0.3); }
        .btn-speak.listening { animation: pulse 1.5s infinite; background-color: #ffcdd2; }
        
        .btn-next { background-color: #fff; border: 2px solid #e8f5e9; color: #2e7d32; margin-top: 20px; font-weight: bold; }

        /* –í–∏–∫—Ç–æ—Ä–∏–Ω–∞ */
        .quiz-option { background-color: #f5f5f5; color: #333; text-align: left; padding-left: 15px; border: 2px solid transparent; }
        .quiz-option.correct { background-color: #c8e6c9; border-color: #4caf50; }
        .quiz-option.wrong { background-color: #ffcdd2; border-color: #e53935; }

        /* –°—Ç–∞—Ç—É—Å –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å */
        .status { margin-top: 10px; font-weight: bold; height: 20px; font-size: 0.9rem; }
        .status.success { color: #2e7d32; }
        .status.error { color: #c62828; }
        .progress-container { width: 100%; background-color: #eee; height: 5px; margin-top: 20px; border-radius: 3px; }
        .progress-bar { height: 100%; background-color: #4caf50; width: 0%; border-radius: 3px; transition: width 0.3s; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        #settingsModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 85%; max-width: 350px; max-height: 85vh; overflow-y: auto; }
        
        .settings-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .settings-section h3 { margin: 0 0 10px 0; font-size: 1rem; color: #333; }
        
        .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .control-label { font-size: 0.9rem; color: #555; }
        
        /* –°–ª–∞–π–¥–µ—Ä –∏ —Å–µ–ª–µ–∫—Ç */
        input[type=range] { width: 100px; }
        select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; margin-top: 5px; font-size: 0.9rem;}

        .category-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(20px); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="mode-switch">
        <button class="mode-btn active" id="modeSpeak" onclick="setMode('speak')">üéôÔ∏è –ì–æ–≤–æ—Ä–∏—Ç—å</button>
        <button class="mode-btn" id="modeQuiz" onclick="setMode('quiz')">üß† –¢–µ—Å—Ç</button>
    </div>
    <button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
</div>

<div class="card">
    <div class="main-word" id="mainWordDisplay">Loading...</div>
    <div class="transcription" id="transcriptionDisplay"></div> 
    <div class="sub-word" id="subWordDisplay">...</div>

    <button class="btn btn-listen" onclick="playCurrentWord(true)">üëÇ –°–ª—É—à–∞—Ç—å (EN + RU)</button>

    <div id="speakContainer">
        <button class="btn btn-speak" id="micBtn" onclick="startListening()">üéôÔ∏è</button>
        <div style="margin-top: 10px; color: #666; font-size: 0.8rem;">–ù–∞–∂–º–∏ –∏ –Ω–∞–∑–æ–≤–∏ —Å–ª–æ–≤–æ</div>
    </div>

    <div id="quizContainer" class="hidden">
        <div id="quizOptions"></div>
    </div>
    
    <div class="status" id="statusMessage"></div>
    
    <button class="btn btn-next" onclick="nextWord()">–î–∞–ª—å—à–µ ‚û°Ô∏è</button>
    
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
</div>

<div id="settingsModal">
    <div class="modal-content">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        
        <div class="settings-section">
            <h3>üîä –ó–≤—É–∫ –∏ –ì–æ–ª–æ—Å</h3>
            
            <div class="control-row">
                <span class="control-label">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="speedVal">0.8</span>x</span>
                <input type="range" min="0.5" max="1.5" step="0.1" value="0.8" oninput="updateSpeed(this.value)">
            </div>

            <div style="margin-top: 10px;">
                <span class="control-label">–ì–æ–ª–æ—Å (EN):</span>
                <select id="voiceSelect" onchange="changeVoice()"></select>
            </div>
        </div>

        <div class="settings-section">
            <h3>üìö –¢–µ–º—ã (–ü–∞–∫–µ—Ç—ã)</h3>
            <div id="categoriesList" style="max-height: 200px; overflow-y: auto;"></div>
        </div>

        <button class="btn btn-listen" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
    // --- 1. –î–ê–ù–ù–´–ï (–§–æ—Ä–º–∞—Ç: EN | RU | TRANSCRIPTION) ---
    const rawData = [
        // –ü–∞–∫–µ—Ç 1: –û—Å–Ω–æ–≤—ã (–±–µ–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –ø–æ–∫–∞)
        "I|–Ø", "You|–¢—ã/–í—ã", "He|–û–Ω", "She|–û–Ω–∞", "It|–≠—Ç–æ/–û–Ω–æ", "We|–ú—ã", "They|–û–Ω–∏", "Yes|–î–∞", "No|–ù–µ—Ç", "And|–ò", 
        "But|–ù–æ", "Or|–ò–ª–∏", "Because|–ü–æ—Ç–æ–º—É —á—Ç–æ", "Hello|–ü—Ä–∏–≤–µ—Ç", "Goodbye|–ü–æ–∫–∞", "Please|–ü–æ–∂–∞–ª—É–π—Å—Ç–∞", "Thanks|–°–ø–∞—Å–∏–±–æ", "Good|–•–æ—Ä–æ—à–∏–π", "Bad|–ü–ª–æ—Ö–æ–π", "Big|–ë–æ–ª—å—à–æ–π",
        "Small|–ú–∞–ª–µ–Ω—å–∫–∏–π", "Now|–°–µ–π—á–∞—Å", "Later|–ü–æ–∑–∂–µ", "Here|–ó–¥–µ—Å—å", "There|–¢–∞–º", "This|–≠—Ç–æ—Ç", "That|–¢–æ—Ç", "Who|–ö—Ç–æ", "What|–ß—Ç–æ", "Where|–ì–¥–µ",
        "When|–ö–æ–≥–¥–∞", "Why|–ü–æ—á–µ–º—É", "How|–ö–∞–∫", "All|–í—Å–µ", "Some|–ù–µ–º–Ω–æ–≥–æ", "Many|–ú–Ω–æ–≥–æ", "Other|–î—Ä—É–≥–æ–π", "Same|–¢–∞–∫–æ–π –∂–µ", "Very|–û—á–µ–Ω—å", "Really|–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ",
        "With|–°", "Without|–ë–µ–∑", "For|–î–ª—è", "From|–û—Ç/–ò–∑", "To|–í/–ö", "In|–í", "On|–ù–∞", "Under|–ü–æ–¥", "Day|–î–µ–Ω—å", "Night|–ù–æ—á—å",

        // –ü–∞–∫–µ—Ç 2
        "Be|–ë—ã—Ç—å", "Do|–î–µ–ª–∞—Ç—å", "Have|–ò–º–µ—Ç—å", "Go|–ò–¥—Ç–∏", "See|–í–∏–¥–µ—Ç—å", "Get|–ü–æ–ª—É—á–∞—Ç—å", "Make|–°–æ–∑–¥–∞–≤–∞—Ç—å", "Know|–ó–Ω–∞—Ç—å", "Think|–î—É–º–∞—Ç—å", "Take|–ë—Ä–∞—Ç—å",
        "Come|–ü—Ä–∏—Ö–æ–¥–∏—Ç—å", "Say|–°–∫–∞–∑–∞—Ç—å", "Put|–ö–ª–∞—Å—Ç—å", "Want|–•–æ—Ç–µ—Ç—å", "Give|–î–∞–≤–∞—Ç—å", "Look|–°–º–æ—Ç—Ä–µ—Ç—å", "Find|–ù–∞—Ö–æ–¥–∏—Ç—å", "Need|–ù—É–∂–¥–∞—Ç—å—Å—è", "Like|–ù—Ä–∞–≤–∏—Ç—å—Å—è", "Work|–†–∞–±–æ—Ç–∞—Ç—å",
        "Use|–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å", "Help|–ü–æ–º–æ–≥–∞—Ç—å", "Play|–ò–≥—Ä–∞—Ç—å", "Move|–î–≤–∏–≥–∞—Ç—å—Å—è", "Live|–ñ–∏—Ç—å", "Believe|–í–µ—Ä–∏—Ç—å", "Bring|–ü—Ä–∏–Ω–æ—Å–∏—Ç—å", "Happen|–°–ª—É—á–∞—Ç—å—Å—è", "Write|–ü–∏—Å–∞—Ç—å", "Read|–ß–∏—Ç–∞—Ç—å",
        "Speak|–ì–æ–≤–æ—Ä–∏—Ç—å", "Hear|–°–ª—ã—à–∞—Ç—å", "Meet|–í—Å—Ç—Ä–µ—á–∞—Ç—å", "Run|–ë–µ–∂–∞—Ç—å", "Pay|–ü–ª–∞—Ç–∏—Ç—å", "Sit|–°–∏–¥–µ—Ç—å", "Stand|–°—Ç–æ—è—Ç—å", "Lose|–¢–µ—Ä—è—Ç—å", "Win|–ü–æ–±–µ–∂–¥–∞—Ç—å", "Learn|–£—á–∏—Ç—å",
        "Change|–ú–µ–Ω—è—Ç—å", "Stop|–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å", "Open|–û—Ç–∫—Ä—ã–≤–∞—Ç—å", "Close|–ó–∞–∫—Ä—ã–≤–∞—Ç—å", "Walk|–ì—É–ª—è—Ç—å", "Eat|–ö—É—à–∞—Ç—å", "Drink|–ü–∏—Ç—å", "Sleep|–°–ø–∞—Ç—å", "Buy|–ü–æ–∫—É–ø–∞—Ç—å", "Sell|–ü—Ä–æ–¥–∞–≤–∞—Ç—å",
        
        // --- –ü–ê–ö–ï–¢ 9: –ú–ê–ì–ê–ó–ò–ù (–° –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–ï–ô) ---
        "Shop|–ú–∞–≥–∞–∑–∏–Ω|–®–æ–ø", 
        "Store|–ú–∞–≥–∞–∑–∏–Ω (—É–Ω–∏–≤–µ—Ä–º–∞–≥)|–°—Ç–æ—Ä", 
        "Supermarket|–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç|–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç", 
        "Open|–û—Ç–∫—Ä—ã—Ç–æ|–û—É–ø–µ–Ω", 
        "Closed|–ó–∞–∫—Ä—ã—Ç–æ|–ö–ª–æ—É–∑–¥", 
        "Price|–¶–µ–Ω–∞|–ü—Ä–∞–π—Å", 
        "Cheap|–î–µ—à–µ–≤—ã–π|–ß–∏–ø", 
        "Expensive|–î–æ—Ä–æ–≥–æ–π|–≠–∫—Å–ø–µ–Ω—Å–∏–≤", 
        "Buy|–ü–æ–∫—É–ø–∞—Ç—å|–ë–∞–π", 
        "Pay|–ü–ª–∞—Ç–∏—Ç—å|–ü—ç–π", 
        "Cash|–ù–∞–ª–∏—á–Ω—ã–µ|–ö—ç—à", 
        "Card|–ö–∞—Ä—Ç–∞|–ö–∞—Ä–¥", 
        "Check|–ß–µ–∫ (–°—á–µ—Ç)|–ß–µ–∫", 
        "Basket|–ö–æ—Ä–∑–∏–Ω–∞|–ë–∞—Å–∫–µ—Ç", 
        "Cart|–¢–µ–ª–µ–∂–∫–∞|–ö–∞—Ä—Ç", 
        "Bag|–°—É–º–∫–∞/–ü–∞–∫–µ—Ç|–ë—ç–≥", 
        "Milk|–ú–æ–ª–æ–∫–æ|–ú–∏–ª–∫", 
        "Bread|–•–ª–µ–±|–ë—Ä—ç–¥", 
        "Egg|–Ø–π—Ü–æ|–≠–≥–≥", 
        "Cheese|–°—ã—Ä|–ß–∏–∑", 
        "Meat|–ú—è—Å–æ|–ú–∏—Ç", 
        "Chicken|–ö—É—Ä–∏—Ü–∞|–ß–∏–∫–µ–Ω", 
        "Fish|–†—ã–±–∞|–§–∏—à", 
        "Water|–í–æ–¥–∞|–í–æ—Ç–µ—Ä", 
        "Juice|–°–æ–∫|–î–∂—É—Å", 
        "Coffee|–ö–æ—Ñ–µ|–ö–æ—Ñ–∏", 
        "Tea|–ß–∞–π|–¢–∏", 
        "Sugar|–°–∞—Ö–∞—Ä|–®—É–≥–∞—Ä", 
        "Salt|–°–æ–ª—å|–°–æ–ª—Ç", 
        "Fruit|–§—Ä—É–∫—Ç|–§—Ä—É—Ç", 
        "Vegetable|–û–≤–æ—â|–í–µ–¥–∂–µ—Ç—ç–±–ª", 
        "Apple|–Ø–±–ª–æ–∫–æ|–≠–ø–ª", 
        "Banana|–ë–∞–Ω–∞–Ω|–ë—ç–Ω–∞–Ω–∞", 
        "Potato|–ö–∞—Ä—Ç–æ—à–∫–∞|–ü–æ—Ç—ç–π—Ç–æ", 
        "Tomato|–ü–æ–º–∏–¥–æ—Ä|–¢–æ–º—ç–π—Ç–æ",
        "Sale|–†–∞—Å–ø—Ä–æ–¥–∞–∂–∞|–°—ç–π–ª",
        "Discount|–°–∫–∏–¥–∫–∞|–î–∏—Å–∫–∞—É–Ω—Ç",
        "Customer|–ü–æ–∫—É–ø–∞—Ç–µ–ª—å|–ö–∞—Å—Ç–æ–º–µ—Ä",
        "Seller|–ü—Ä–æ–¥–∞–≤–µ—Ü|–°–µ–ª–ª–µ—Ä",
        "Money|–î–µ–Ω—å–≥–∏|–ú–∞–Ω–∏",
        
        // --- –ü–ê–ö–ï–¢ 10: –ß–ò–°–õ–ê (–° –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–ï–ô) ---
        "Zero|–ù–æ–ª—å|–ó–∏—Ä–æ", 
        "One|–û–¥–∏–Ω|–í–∞–Ω", 
        "Two|–î–≤–∞|–¢—É", 
        "Three|–¢—Ä–∏|–°—Ä–∏", 
        "Four|–ß–µ—Ç—ã—Ä–µ|–§–æ", 
        "Five|–ü—è—Ç—å|–§–∞–π–≤", 
        "Six|–®–µ—Å—Ç—å|–°–∏–∫—Å", 
        "Seven|–°–µ–º—å|–°–µ–≤–µ–Ω", 
        "Eight|–í–æ—Å–µ–º—å|–≠–π—Ç", 
        "Nine|–î–µ–≤—è—Ç—å|–ù–∞–π–Ω", 
        "Ten|–î–µ—Å—è—Ç—å|–¢—ç–Ω", 
        "Eleven|–û–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å|–ò–ª–µ–≤–µ–Ω", 
        "Twelve|–î–≤–µ–Ω–∞–¥—Ü–∞—Ç—å|–¢–≤–µ–ª–≤", 
        "Thirteen|–¢—Ä–∏–Ω–∞–¥—Ü–∞—Ç—å|–°—ë—Ç–∏–Ω", 
        "Fourteen|–ß–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç—å|–§–æ—Ç–∏–Ω", 
        "Fifteen|–ü—è—Ç–Ω–∞–¥—Ü–∞—Ç—å|–§–∏—Ñ—Ç–∏–Ω", 
        "Sixteen|–®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å|–°–∏–∫—Å—Ç–∏–Ω", 
        "Seventeen|–°–µ–º–Ω–∞–¥—Ü–∞—Ç—å|–°–µ–≤–µ–Ω—Ç–∏–Ω", 
        "Eighteen|–í–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å|–≠–π—Ç–∏–Ω", 
        "Nineteen|–î–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç—å|–ù–∞–π–Ω—Ç–∏–Ω", 
        "Twenty|–î–≤–∞–¥—Ü–∞—Ç—å|–¢–≤–µ–Ω—Ç–∏", 
        "Thirty|–¢—Ä–∏–¥—Ü–∞—Ç—å|–°—ë—Ç–∏", 
        "Forty|–°–æ—Ä–æ–∫|–§–æ—Ç–∏", 
        "Fifty|–ü—è—Ç—å–¥–µ—Å—è—Ç|–§–∏—Ñ—Ç–∏", 
        "Sixty|–®–µ—Å—Ç—å–¥–µ—Å—è—Ç|–°–∏–∫—Å—Ç–∏", 
        "Seventy|–°–µ–º—å–¥–µ—Å—è—Ç|–°–µ–≤–µ–Ω—Ç–∏", 
        "Eighty|–í–æ—Å–µ–º—å–¥–µ—Å—è—Ç|–≠–π—Ç–∏", 
        "Ninety|–î–µ–≤—è–Ω–æ—Å—Ç–æ|–ù–∞–π–Ω—Ç–∏", 
        "One Hundred|–°—Ç–æ|–í–∞–Ω –•–∞–Ω–¥—Ä–µ–¥",
        "Number|–ß–∏—Å–ª–æ|–ù–∞–º–±–µ—Ä",
        "Count|–°—á–∏—Ç–∞—Ç—å|–ö–∞—É–Ω—Ç",
        "How much?|–°–∫–æ–ª—å–∫–æ?|–•–∞—É –º–∞—á"
    ];

    // --- 2. –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
    let wordCollections = {}; 
    let activeVocabulary = [];
    let currentIndex = 0;
    let currentMode = 'speak'; 
    let globalWordCounter = 0; 
    
    // –ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    let speechRate = 0.8; 
    let selectedVoiceIndex = 0;
    let voices = [];

    const synth = window.speechSynthesis;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    // --- 3. –õ–û–ì–ò–ö–ê –ü–ê–†–°–ò–ù–ì–ê ---
    function parseDataToCollections() {
        wordCollections = {};
        const packNames = {
            1: "–ü–∞–∫–µ—Ç 1: –û—Å–Ω–æ–≤—ã",
            9: "–ú–∞–≥–∞–∑–∏–Ω (NEW)",
            10: "–ß–∏—Å–ª–∞ (NEW)"
        };

        let currentPackNum = 1;

        rawData.forEach((item) => {
            const parts = item.split('|');
            const en = parts[0];
            const ru = parts[1];
            const trans = parts[2] || ""; 
            
            if (en === "Shop") currentPackNum = 9;
            if (en === "Zero") currentPackNum = 10;
            
            const key = "pack" + currentPackNum;

            if (!wordCollections[key]) {
                wordCollections[key] = {
                    name: packNames[currentPackNum] || `–ü–∞–∫–µ—Ç ${currentPackNum}`,
                    active: currentPackNum === 9 || currentPackNum === 10,
                    words: []
                };
            }
            wordCollections[key].words.push({ en, ru, trans });
        });
    }

    // --- 4. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    function init() {
        parseDataToCollections();
        buildVocabulary();
        
        populateVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoices;
        }

        renderSettings();
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.onstart = () => {
                document.getElementById('micBtn').classList.add('listening');
                updateStatus("–°–ª—É—à–∞—é...", "waiting");
            };
            recognition.onend = () => {
                document.getElementById('micBtn').classList.remove('listening');
            };
            recognition.onresult = handleSpeechResult;
            recognition.onerror = (e) => updateStatus("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è", "error");
        }
        
        loadWord(0);
    }

    function populateVoices() {
        voices = synth.getVoices().filter(v => v.lang.startsWith('en'));
        const select = document.getElementById('voiceSelect');
        select.innerHTML = '';
        
        voices.forEach((voice, index) => {
            const option = document.createElement('option');
            option.textContent = `${voice.name} (${voice.lang})`;
            option.value = index;
            select.appendChild(option);
        });
        
        const defaultIndex = voices.findIndex(v => v.name.includes('Google US') || v.name.includes('David'));
        if (defaultIndex !== -1) {
            select.selectedIndex = defaultIndex;
            selectedVoiceIndex = defaultIndex;
        }
    }

    function changeVoice() {
        const select = document.getElementById('voiceSelect');
        selectedVoiceIndex = select.value;
        const utter = new SpeechSynthesisUtterance("Hello");
        utter.voice = voices[selectedVoiceIndex];
        utter.rate = speechRate;
        synth.speak(utter);
    }

    function updateSpeed(val) {
        speechRate = parseFloat(val);
        document.getElementById('speedVal').innerText = speechRate;
    }

    function buildVocabulary() {
        activeVocabulary = [];
        const sortedKeys = Object.keys(wordCollections).sort((a,b) => {
            return parseInt(a.replace('pack','')) - parseInt(b.replace('pack',''));
        });

        for (let key of sortedKeys) {
            if (wordCollections[key].active) {
                activeVocabulary = activeVocabulary.concat(wordCollections[key].words);
            }
        }
        
        activeVocabulary.sort(() => Math.random() - 0.5);
        if (activeVocabulary.length === 0) {
            activeVocabulary = [{en: "Select a Pack", ru: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö", trans: ""}];
        }
    }

    // --- 5. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï ---
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('modeSpeak').className = mode === 'speak' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('modeQuiz').className = mode === 'quiz' ? 'mode-btn active' : 'mode-btn';
        
        document.getElementById('speakContainer').className = mode === 'speak' ? '' : 'hidden';
        document.getElementById('quizContainer').className = mode === 'quiz' ? '' : 'hidden';
        
        loadWord(currentIndex);
    }

    function loadWord(index) {
        currentIndex = index;
        const item = activeVocabulary[currentIndex];
        const statusEl = document.getElementById('statusMessage');
        statusEl.innerText = "";
        statusEl.className = "status";

        const mainEl = document.getElementById('mainWordDisplay');
        const transEl = document.getElementById('transcriptionDisplay');
        const subEl = document.getElementById('subWordDisplay');

        if (currentMode === 'speak') {
            mainEl.innerText = item.en;
            transEl.innerText = item.trans ? `[ ${item.trans} ]` : "";
            subEl.innerText = item.ru;
        } else {
            mainEl.innerText = "???"; 
            transEl.innerText = "";
            subEl.innerText = "–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è —ç—Ç–æ —Å–ª–æ–≤–æ?";
            generateQuizButtons(item);
            speakEnglish(item.en);
        }
        
        const progress = ((index + 1) / activeVocabulary.length) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
    }

    // --- 6. –ê–£–î–ò–û ---
    function playCurrentWord(playRussianToo = false) {
        const item = activeVocabulary[currentIndex];
        speakEnglish(item.en);
        if (playRussianToo) {
            speakRussian(item.ru);
        }
    }

    function speakEnglish(text, callback) {
        if (synth.speaking) synth.cancel();

        // –®–£–¢–ö–ê (—Ä–∞–∑ –≤ 20 —Å–ª–æ–≤)
        if (globalWordCounter > 0 && globalWordCounter % 20 === 0) {
            const joke = new SpeechSynthesisUtterance("–ö–∞–∫ —Ç–µ–±–µ —Å –º—É–∂–µ–º –ø–æ–≤–µ–∑–ª–æ, –¢–∞–Ω—è");
            joke.lang = 'ru-RU';
            synth.speak(joke);
        }

        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        utter.rate = speechRate;
        if (voices[selectedVoiceIndex]) {
            utter.voice = voices[selectedVoiceIndex];
        }
        if (callback) utter.onend = callback;
        synth.speak(utter);
    }

    function speakRussian(text) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'ru-RU'; 
        utter.rate = 1.0; 
        synth.speak(utter);
    }

    // --- 7. –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ò –í–ò–ö–¢–û–†–ò–ù–ê ---
    function startListening() {
        if (!recognition) { alert("–ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è"); return; }
        recognition.start();
    }

    function handleSpeechResult(event) {
        const spoken = event.results[0][0].transcript.toLowerCase();
        const target = activeVocabulary[currentIndex].en.toLowerCase();
        const cleanSpoken = spoken.replace(/[^a-z]/g, '');
        const cleanTarget = target.replace(/[^a-z]/g, '');

        if (cleanSpoken.includes(cleanTarget) || cleanTarget.includes(cleanSpoken)) {
            updateStatus(`–í–µ—Ä–Ω–æ! (${spoken})`, "success");
            speakRussian("–•–æ—Ä–æ—à–æ"); // –•–í–ê–õ–ò–ú
        } else {
            updateStatus(`–£—Å–ª—ã—à–∞–ª: ${spoken}`, "error");
            speakEnglish(activeVocabulary[currentIndex].en); // –ò–°–ü–†–ê–í–õ–Ø–ï–ú (–≥–æ–≤–æ—Ä–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ)
        }
    }

    function generateQuizButtons(correctItem) {
        const container = document.getElementById('quizOptions');
        container.innerHTML = '';
        let options = [correctItem];
        let pool = activeVocabulary.filter(w => w.en !== correctItem.en);
        if (pool.length < 2) pool = pool.concat(pool); 
        pool.sort(() => Math.random() - 0.5);
        options.push(pool[0]);
        if (pool[1]) options.push(pool[1]);
        options.sort(() => Math.random() - 0.5);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn quiz-option';
            btn.innerText = opt.ru;
            btn.onclick = () => checkQuizAnswer(btn, opt, correctItem);
            container.appendChild(btn);
        });
    }

    function checkQuizAnswer(btn, selected, correct) {
        if (selected.en === correct.en) {
            btn.classList.add('correct');
            document.getElementById('mainWordDisplay').innerText = correct.en;
            if (correct.trans) document.getElementById('transcriptionDisplay').innerText = `[ ${correct.trans} ]`;
            updateStatus("–ü—Ä–∞–≤–∏–ª—å–Ω–æ!", "success");
            speakRussian("–•–æ—Ä–æ—à–æ"); // –•–í–ê–õ–ò–ú
        } else {
            btn.classList.add('wrong');
            updateStatus("–ù–µ —Å–æ–≤—Å–µ–º...", "error");
            speakEnglish(correct.en); // –ò–°–ü–†–ê–í–õ–Ø–ï–ú
        }
    }

    function nextWord() {
        globalWordCounter++;
        let newIndex = currentIndex + 1;
        if (newIndex >= activeVocabulary.length) newIndex = 0;
        loadWord(newIndex);
    }

    function updateStatus(text, type) {
        const el = document.getElementById('statusMessage');
        el.innerText = text;
        el.className = "status " + type;
    }

    // --- 8. –ù–ê–°–¢–†–û–ô–ö–ò UI ---
    function toggleSettings() {
        const modal = document.getElementById('settingsModal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function renderSettings() {
        const list = document.getElementById('categoriesList');
        list.innerHTML = '';
        const sortedKeys = Object.keys(wordCollections).sort((a,b) => {
            return parseInt(a.replace('pack','')) - parseInt(b.replace('pack',''));
        });

        for (let key of sortedKeys) {
            const cat = wordCollections[key];
            const div = document.createElement('div');
            div.className = 'category-item';
            div.innerHTML = `
                <span>${cat.name}</span>
                <label class="switch">
                    <input type="checkbox" id="cat_${key}" ${cat.active ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            `;
            list.appendChild(div);
        }
    }

    function saveSettings() {
        for (let key in wordCollections) {
            const checkbox = document.getElementById(`cat_${key}`);
            wordCollections[key].active = checkbox.checked;
        }
        buildVocabulary();
        toggleSettings();
        globalWordCounter = 0; 
        loadWord(0);
    }

    window.onload = init;
</script>

</body>
</html>
