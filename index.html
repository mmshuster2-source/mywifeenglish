<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Pilot: Tanya Edition</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; margin: 0; padding-top: 20px; box-sizing: border-box; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar { display: flex; justify-content: space-between; width: 90%; max-width: 400px; margin-bottom: 20px; align-items: center; }
        .mode-switch { background: #fff; padding: 5px; border-radius: 20px; display: flex; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .mode-btn { border: none; background: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 14px; opacity: 0.6; transition: 0.3s; }
        .mode-btn.active { background-color: #e3f2fd; color: #1565c0; font-weight: bold; opacity: 1; }
        .settings-btn { background: none; border: none; font-size: 24px; cursor: pointer; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 85%; max-width: 400px; text-align: center; transition: all 0.3s ease; position: relative; }
        
        .main-word { color: #333; font-size: 2.2rem; margin: 15px 0; min-height: 50px; font-weight: bold; word-wrap: break-word;}
        .sub-word { color: #888; font-size: 1.2rem; margin-bottom: 25px; min-height: 28px; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 12px; font-size: 1.1rem; cursor: pointer; transition: transform 0.1s; position: relative; }
        .btn:active { transform: scale(0.98); }
        .btn-listen { background-color: #e3f2fd; color: #1565c0; margin-bottom: 20px; }
        .btn-speak { background-color: #ffebee; color: #c62828; font-weight: bold; font-size: 1.3rem; padding: 20px; border-radius: 50px; width: 80px; height: 80px; margin: 0 auto; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(198, 40, 40, 0.3); }
        .btn-speak.listening { animation: pulse 1.5s infinite; background-color: #ffcdd2; }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ (–¥–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã) */
        .quiz-option { background-color: #f5f5f5; color: #333; text-align: left; padding-left: 20px; border: 2px solid transparent; }
        .quiz-option.correct { background-color: #c8e6c9; border-color: #4caf50; }
        .quiz-option.wrong { background-color: #ffcdd2; border-color: #e53935; }

        .btn-next { background-color: #fff; border: 2px solid #e8f5e9; color: #2e7d32; margin-top: 25px; font-weight: bold; }

        /* –°—Ç–∞—Ç—É—Å –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å */
        .status { margin-top: 15px; font-weight: bold; height: 24px; font-size: 0.95rem; }
        .status.success { color: #2e7d32; }
        .status.error { color: #c62828; }
        .progress-container { width: 100%; background-color: #eee; height: 6px; margin-top: 25px; border-radius: 3px; }
        .progress-bar { height: 100%; background-color: #4caf50; width: 0%; border-radius: 3px; transition: width 0.3s; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        #settingsModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; max-height: 80vh; overflow-y: auto; }
        .category-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .hidden { display: none !important; }
        
        .counter-debug { font-size: 10px; color: #ccc; position: absolute; bottom: 5px; right: 5px; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="mode-switch">
        <button class="mode-btn active" id="modeSpeak" onclick="setMode('speak')">üéôÔ∏è –ì–æ–≤–æ—Ä–∏—Ç—å</button>
        <button class="mode-btn" id="modeQuiz" onclick="setMode('quiz')">üß† –¢–µ—Å—Ç</button>
    </div>
    <button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
</div>

<div class="card">
    <div class="translation" id="subWordDisplay">...</div>
    <div class="main-word" id="mainWordDisplay">Loading...</div>

    <button class="btn btn-listen" onclick="playCurrentWord(true)">üëÇ –ü–æ—Å–ª—É—à–∞—Ç—å (EN + RU)</button>

    <div id="speakContainer">
        <button class="btn btn-speak" id="micBtn" onclick="startListening()">üéôÔ∏è</button>
        <div style="margin-top: 10px; color: #666; font-size: 0.9rem;">–ù–∞–∂–º–∏ –∏ –Ω–∞–∑–æ–≤–∏ —Å–ª–æ–≤–æ</div>
    </div>

    <div id="quizContainer" class="hidden">
        <div id="quizOptions"></div>
    </div>
    
    <div class="status" id="statusMessage"></div>
    
    <button class="btn btn-next" onclick="nextWord()">–î–∞–ª—å—à–µ ‚û°Ô∏è</button>
    
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="counter-debug" id="debugCounter">0</div>
</div>

<div id="settingsModal">
    <div class="modal-content">
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç—ã</h2>
        <p style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">–í–∫–ª—é—á–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –ø–∞–∫–µ—Ç—ã —Å–ª–æ–≤:</p>
        <div id="categoriesList"></div>
        <button class="btn btn-listen" style="margin-top: 20px;" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
    // --- 1. –ë–ê–ó–ê –î–ê–ù–ù–´–• (–°–∂–∞—Ç—ã–π —Ñ–æ—Ä–º–∞—Ç) ---
    // 300 —Å–ª–æ–≤ (6 –ø–∞–∫–µ—Ç–æ–≤ –ø–æ 50).
    const rawData = [
        // –ü–∞–∫–µ—Ç 1: –û—Å–Ω–æ–≤—ã (0-49)
        "I|–Ø", "You|–¢—ã/–í—ã", "He|–û–Ω", "She|–û–Ω–∞", "It|–≠—Ç–æ/–û–Ω–æ", "We|–ú—ã", "They|–û–Ω–∏", "Yes|–î–∞", "No|–ù–µ—Ç", "And|–ò", 
        "But|–ù–æ", "Or|–ò–ª–∏", "Because|–ü–æ—Ç–æ–º—É —á—Ç–æ", "Hello|–ü—Ä–∏–≤–µ—Ç", "Goodbye|–ü–æ–∫–∞", "Please|–ü–æ–∂–∞–ª—É–π—Å—Ç–∞", "Thanks|–°–ø–∞—Å–∏–±–æ", "Good|–•–æ—Ä–æ—à–∏–π", "Bad|–ü–ª–æ—Ö–æ–π", "Big|–ë–æ–ª—å—à–æ–π",
        "Small|–ú–∞–ª–µ–Ω—å–∫–∏–π", "Now|–°–µ–π—á–∞—Å", "Later|–ü–æ–∑–∂–µ", "Here|–ó–¥–µ—Å—å", "There|–¢–∞–º", "This|–≠—Ç–æ—Ç", "That|–¢–æ—Ç", "Who|–ö—Ç–æ", "What|–ß—Ç–æ", "Where|–ì–¥–µ",
        "When|–ö–æ–≥–¥–∞", "Why|–ü–æ—á–µ–º—É", "How|–ö–∞–∫", "All|–í—Å–µ", "Some|–ù–µ–º–Ω–æ–≥–æ", "Many|–ú–Ω–æ–≥–æ", "Other|–î—Ä—É–≥–æ–π", "Same|–¢–∞–∫–æ–π –∂–µ", "Very|–û—á–µ–Ω—å", "Really|–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ",
        "With|–°", "Without|–ë–µ–∑", "For|–î–ª—è", "From|–û—Ç/–ò–∑", "To|–í/–ö", "In|–í", "On|–ù–∞", "Under|–ü–æ–¥", "Day|–î–µ–Ω—å", "Night|–ù–æ—á—å",

        // –ü–∞–∫–µ—Ç 2: –ì–ª–∞–≥–æ–ª—ã (50-99)
        "Be|–ë—ã—Ç—å", "Do|–î–µ–ª–∞—Ç—å", "Have|–ò–º–µ—Ç—å", "Go|–ò–¥—Ç–∏", "See|–í–∏–¥–µ—Ç—å", "Get|–ü–æ–ª—É—á–∞—Ç—å", "Make|–°–æ–∑–¥–∞–≤–∞—Ç—å", "Know|–ó–Ω–∞—Ç—å", "Think|–î—É–º–∞—Ç—å", "Take|–ë—Ä–∞—Ç—å",
        "Come|–ü—Ä–∏—Ö–æ–¥–∏—Ç—å", "Say|–°–∫–∞–∑–∞—Ç—å", "Put|–ö–ª–∞—Å—Ç—å", "Want|–•–æ—Ç–µ—Ç—å", "Give|–î–∞–≤–∞—Ç—å", "Look|–°–º–æ—Ç—Ä–µ—Ç—å", "Find|–ù–∞—Ö–æ–¥–∏—Ç—å", "Need|–ù—É–∂–¥–∞—Ç—å—Å—è", "Like|–ù—Ä–∞–≤–∏—Ç—å—Å—è", "Work|–†–∞–±–æ—Ç–∞—Ç—å",
        "Use|–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å", "Help|–ü–æ–º–æ–≥–∞—Ç—å", "Play|–ò–≥—Ä–∞—Ç—å", "Move|–î–≤–∏–≥–∞—Ç—å—Å—è", "Live|–ñ–∏—Ç—å", "Believe|–í–µ—Ä–∏—Ç—å", "Bring|–ü—Ä–∏–Ω–æ—Å–∏—Ç—å", "Happen|–°–ª—É—á–∞—Ç—å—Å—è", "Write|–ü–∏—Å–∞—Ç—å", "Read|–ß–∏—Ç–∞—Ç—å",
        "Speak|–ì–æ–≤–æ—Ä–∏—Ç—å", "Hear|–°–ª—ã—à–∞—Ç—å", "Meet|–í—Å—Ç—Ä–µ—á–∞—Ç—å", "Run|–ë–µ–∂–∞—Ç—å", "Pay|–ü–ª–∞—Ç–∏—Ç—å", "Sit|–°–∏–¥–µ—Ç—å", "Stand|–°—Ç–æ—è—Ç—å", "Lose|–¢–µ—Ä—è—Ç—å", "Win|–ü–æ–±–µ–∂–¥–∞—Ç—å", "Learn|–£—á–∏—Ç—å",
        "Change|–ú–µ–Ω—è—Ç—å", "Stop|–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å", "Open|–û—Ç–∫—Ä—ã–≤–∞—Ç—å", "Close|–ó–∞–∫—Ä—ã–≤–∞—Ç—å", "Walk|–ì—É–ª—è—Ç—å", "Eat|–ö—É—à–∞—Ç—å", "Drink|–ü–∏—Ç—å", "Sleep|–°–ø–∞—Ç—å", "Buy|–ü–æ–∫—É–ø–∞—Ç—å", "Sell|–ü—Ä–æ–¥–∞–≤–∞—Ç—å",

        // –ü–∞–∫–µ—Ç 3: –õ—é–¥–∏ (100-149)
        "Family|–°–µ–º—å—è", "Man|–ú—É–∂—á–∏–Ω–∞", "Woman|–ñ–µ–Ω—â–∏–Ω–∞", "Boy|–ú–∞–ª—å—á–∏–∫", "Girl|–î–µ–≤–æ—á–∫–∞", "Child|–†–µ–±–µ–Ω–æ–∫", "Parent|–†–æ–¥–∏—Ç–µ–ª—å", "Mother|–ú–∞–º–∞", "Father|–ü–∞–ø–∞", "Husband|–ú—É–∂",
        "Wife|–ñ–µ–Ω–∞", "Son|–°—ã–Ω", "Daughter|–î–æ—á—å", "Brother|–ë—Ä–∞—Ç", "Sister|–°–µ—Å—Ç—Ä–∞", "Friend|–î—Ä—É–≥", "Person|–ß–µ–ª–æ–≤–µ–∫", "People|–õ—é–¥–∏", "Name|–ò–º—è", "Job|–†–∞–±–æ—Ç–∞",
        "Doctor|–í—Ä–∞—á", "Teacher|–£—á–∏—Ç–µ–ª—å", "Student|–°—Ç—É–¥–µ–Ω—Ç", "Boss|–ù–∞—á–∞–ª—å–Ω–∏–∫", "King|–ö–æ—Ä–æ–ª—å", "Queen|–ö–æ—Ä–æ–ª–µ–≤–∞", "Team|–ö–æ–º–∞–Ω–¥–∞", "Group|–ì—Ä—É–ø–ø–∞", "Baby|–ú–ª–∞–¥–µ–Ω–µ—Ü", "Guest|–ì–æ—Å—Ç—å",
        "Body|–¢–µ–ª–æ", "Head|–ì–æ–ª–æ–≤–∞", "Hand|–†—É–∫–∞ (–∫–∏—Å—Ç—å)", "Arm|–†—É–∫–∞ (–≤—Å—è)", "Leg|–ù–æ–≥–∞", "Foot|–°—Ç–æ–ø–∞", "Eye|–ì–ª–∞–∑", "Face|–õ–∏—Ü–æ", "Mouth|–†–æ—Ç", "Smile|–£–ª—ã–±–∫–∞",
        "Heart|–°–µ—Ä–¥—Ü–µ", "Brain|–ú–æ–∑–≥", "Hair|–í–æ–ª–æ—Å—ã", "Voice|–ì–æ–ª–æ—Å", "Health|–ó–¥–æ—Ä–æ–≤—å–µ", "Sick|–ë–æ–ª—å–Ω–æ–π", "Strong|–°–∏–ª—å–Ω—ã–π", "Weak|–°–ª–∞–±—ã–π", "Life|–ñ–∏–∑–Ω—å", "Death|–°–º–µ—Ä—Ç—å",

        // –ü–∞–∫–µ—Ç 4: –ï–¥–∞ (150-199)
        "Food|–ï–¥–∞", "Water|–í–æ–¥–∞", "Bread|–•–ª–µ–±", "Meat|–ú—è—Å–æ", "Fish|–†—ã–±–∞", "Fruit|–§—Ä—É–∫—Ç", "Vegetable|–û–≤–æ—â", "Apple|–Ø–±–ª–æ–∫–æ", "Banana|–ë–∞–Ω–∞–Ω", "Orange|–ê–ø–µ–ª—å—Å–∏–Ω",
        "Potato|–ö–∞—Ä—Ç–æ—à–∫–∞", "Tomato|–ü–æ–º–∏–¥–æ—Ä", "Egg|–Ø–π—Ü–æ", "Cheese|–°—ã—Ä", "Milk|–ú–æ–ª–æ–∫–æ", "Coffee|–ö–æ—Ñ–µ", "Tea|–ß–∞–π", "Sugar|–°–∞—Ö–∞—Ä", "Salt|–°–æ–ª—å", "Soup|–°—É–ø",
        "Breakfast|–ó–∞–≤—Ç—Ä–∞–∫", "Lunch|–û–±–µ–¥", "Dinner|–£–∂–∏–Ω", "Knife|–ù–æ–∂", "Fork|–í–∏–ª–∫–∞", "Spoon|–õ–æ–∂–∫–∞", "Plate|–¢–∞—Ä–µ–ª–∫–∞", "Cup|–ß–∞—à–∫–∞", "Bottle|–ë—É—Ç—ã–ª–∫–∞", "Glass|–°—Ç–∞–∫–∞–Ω",
        "Table|–°—Ç–æ–ª", "Restaurant|–†–µ—Å—Ç–æ—Ä–∞–Ω", "Menu|–ú–µ–Ω—é", "Order|–ó–∞–∫–∞–∑", "Cook|–ì–æ—Ç–æ–≤–∏—Ç—å", "Taste|–í–∫—É—Å", "Sweet|–°–ª–∞–¥–∫–∏–π", "Sour|–ö–∏—Å–ª—ã–π", "Fresh|–°–≤–µ–∂–∏–π", "Hot|–ì–æ—Ä—è—á–∏–π",
        "Cold|–•–æ–ª–æ–¥–Ω—ã–π", "Ice|–õ—ë–¥", "Cake|–¢–æ—Ä—Ç", "Cookie|–ü–µ—á–µ–Ω—å–µ", "Beer|–ü–∏–≤–æ", "Wine|–í–∏–Ω–æ", "Juice|–°–æ–∫", "Oil|–ú–∞—Å–ª–æ", "Pepper|–ü–µ—Ä–µ—Ü", "Chicken|–ö—É—Ä–∏—Ü–∞",

        // –ü–∞–∫–µ—Ç 5: –î–æ–º (200-249)
        "House|–î–æ–º", "Home|–î–æ–º–∞—à–Ω–∏–π –æ—á–∞–≥", "Room|–ö–æ–º–Ω–∞—Ç–∞", "Bedroom|–°–ø–∞–ª—å–Ω—è", "Kitchen|–ö—É—Ö–Ω—è", "Bathroom|–í–∞–Ω–Ω–∞—è", "Door|–î–≤–µ—Ä—å", "Window|–û–∫–Ω–æ", "Floor|–ü–æ–ª", "Wall|–°—Ç–µ–Ω–∞",
        "Roof|–ö—Ä—ã—à–∞", "Garden|–°–∞–¥", "Key|–ö–ª—é—á", "Bed|–ö—Ä–æ–≤–∞—Ç—å", "Chair|–°—Ç—É–ª", "Sofa|–î–∏–≤–∞–Ω", "Lamp|–õ–∞–º–ø–∞", "Light|–°–≤–µ—Ç", "Picture|–ö–∞—Ä—Ç–∏–Ω–∞", "Mirror|–ó–µ—Ä–∫–∞–ª–æ",
        "Box|–ö–æ—Ä–æ–±–∫–∞", "Bag|–°—É–º–∫–∞", "Computer|–ö–æ–º–ø—å—é—Ç–µ—Ä", "Phone|–¢–µ–ª–µ—Ñ–æ–Ω", "Paper|–ë—É–º–∞–≥–∞", "Pen|–†—É—á–∫–∞", "Book|–ö–Ω–∏–≥–∞", "Clock|–ß–∞—Å—ã", "Watch|–ù–∞—Ä—É—á–Ω—ã–µ —á–∞—Å—ã", "Radio|–†–∞–¥–∏–æ",
        "TV|–¢–µ–ª–µ–≤–∏–∑–æ—Ä", "Music|–ú—É–∑—ã–∫–∞", "Song|–ü–µ—Å–Ω—è", "Clean|–ß–∏—Å—Ç—ã–π", "Dirty|–ì—Ä—è–∑–Ω—ã–π", "Wash|–ú—ã—Ç—å", "Shower|–î—É—à", "Soap|–ú—ã–ª–æ", "Towel|–ü–æ–ª–æ—Ç–µ–Ω—Ü–µ", "Toilet|–¢—É–∞–ª–µ—Ç",
        "Trash|–ú—É—Å–æ—Ä", "Tool|–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç", "Fire|–û–≥–æ–Ω—å", "City|–ì–æ—Ä–æ–¥", "Street|–£–ª–∏—Ü–∞", "Road|–î–æ—Ä–æ–≥–∞", "Car|–ú–∞—à–∏–Ω–∞", "Bus|–ê–≤—Ç–æ–±—É—Å", "Train|–ü–æ–µ–∑–¥", "Plane|–°–∞–º–æ–ª–µ—Ç",

        // –ü–∞–∫–µ—Ç 6: –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∏ –ü—Ä–∏—Ä–æ–¥–∞ (250-299)
        "Happy|–°—á–∞—Å—Ç–ª–∏–≤—ã–π", "Sad|–ì—Ä—É—Å—Ç–Ω—ã–π", "Angry|–ó–ª–æ–π", "Kind|–î–æ–±—Ä—ã–π", "Rich|–ë–æ–≥–∞—Ç—ã–π", "Poor|–ë–µ–¥–Ω—ã–π", "Fast|–ë—ã—Å—Ç—Ä—ã–π", "Slow|–ú–µ–¥–ª–µ–Ω–Ω—ã–π", "Hard|–¢—è–∂–µ–ª—ã–π/–¢–≤–µ—Ä–¥—ã–π", "Soft|–ú—è–≥–∫–∏–π",
        "Easy|–õ–µ–≥–∫–∏–π", "Difficult|–°–ª–æ–∂–Ω—ã–π", "True|–ü—Ä–∞–≤–¥–∏–≤—ã–π", "False|–õ–æ–∂–Ω—ã–π", "Right|–ü—Ä–∞–≤—ã–π/–í–µ—Ä–Ω—ã–π", "Left|–õ–µ–≤—ã–π", "High|–í—ã—Å–æ–∫–∏–π", "Low|–ù–∏–∑–∫–∏–π", "Long|–î–ª–∏–Ω–Ω—ã–π", "Short|–ö–æ—Ä–æ—Ç–∫–∏–π",
        "New|–ù–æ–≤—ã–π", "Old|–°—Ç–∞—Ä—ã–π", "Young|–ú–æ–ª–æ–¥–æ–π", "Beautiful|–ö—Ä–∞—Å–∏–≤—ã–π", "Ugly|–£—Ä–æ–¥–ª–∏–≤—ã–π", "Red|–ö—Ä–∞—Å–Ω—ã–π", "Blue|–°–∏–Ω–∏–π", "Green|–ó–µ–ª–µ–Ω—ã–π", "Yellow|–ñ–µ–ª—Ç—ã–π", "Black|–ß–µ—Ä–Ω—ã–π",
        "White|–ë–µ–ª—ã–π", "Sun|–°–æ–ª–Ω—Ü–µ", "Moon|–õ—É–Ω–∞", "Star|–ó–≤–µ–∑–¥–∞", "Sky|–ù–µ–±–æ", "Cloud|–û–±–ª–∞–∫–æ", "Rain|–î–æ–∂–¥—å", "Snow|–°–Ω–µ–≥", "Wind|–í–µ—Ç–µ—Ä", "Tree|–î–µ—Ä–µ–≤–æ",
        "Flower|–¶–≤–µ—Ç–æ–∫", "Grass|–¢—Ä–∞–≤–∞", "Bird|–ü—Ç–∏—Ü–∞", "Dog|–°–æ–±–∞–∫–∞", "Cat|–ö–æ—Ç", "Animal|–ñ–∏–≤–æ—Ç–Ω–æ–µ", "Sea|–ú–æ—Ä–µ", "River|–†–µ–∫–∞", "World|–ú–∏—Ä", "Map|–ö–∞—Ä—Ç–∞"
    ];

    // --- 2. –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
    
    let wordCollections = {}; // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –∏–∑ rawData
    let activeVocabulary = [];
    let currentIndex = 0;
    let currentMode = 'speak'; // 'speak' or 'quiz'
    
    // –°—á–µ—Ç—á–∏–∫ –¥–ª—è —à—É—Ç–∫–∏
    let globalWordCounter = 0; 
    
    const synth = window.speechSynthesis;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö (–°–æ–∑–¥–∞–µ–º –ø–∞–∫–µ—Ç—ã –ø–æ 50 —Å–ª–æ–≤)
    function parseDataToCollections() {
        const PACK_SIZE = 50;
        
        // –û—á–∏—Å—Ç–∫–∞
        wordCollections = {};

        rawData.forEach((item, index) => {
            const parts = item.split('|');
            const packNum = Math.floor(index / PACK_SIZE) + 1;
            const key = "pack" + packNum;

            if (!wordCollections[key]) {
                // –ü–∞–∫–µ—Ç 1 –∞–∫—Ç–∏–≤–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–µ—Ç
                wordCollections[key] = {
                    name: `–ü–∞–∫–µ—Ç ${packNum} (${(packNum-1)*PACK_SIZE} - ${packNum*PACK_SIZE})`,
                    active: packNum === 1, 
                    words: []
                };
            }
            wordCollections[key].words.push({ en: parts[0], ru: parts[1] });
        });
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    function init() {
        parseDataToCollections();
        buildVocabulary();
        renderSettings();
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.onstart = () => {
                document.getElementById('micBtn').classList.add('listening');
                updateStatus("–°–ª—É—à–∞—é...", "waiting");
            };
            recognition.onend = () => {
                document.getElementById('micBtn').classList.remove('listening');
            };
            recognition.onresult = handleSpeechResult;
            recognition.onerror = (e) => updateStatus("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è", "error");
        }
        
        loadWord(0);
    }

    function buildVocabulary() {
        activeVocabulary = [];
        for (let key in wordCollections) {
            if (wordCollections[key].active) {
                activeVocabulary = activeVocabulary.concat(wordCollections[key].words);
            }
        }
        // –ü–µ—Ä–µ–º–µ—à–∞—Ç—å —Å–ª–æ–≤–∞
        activeVocabulary.sort(() => Math.random() - 0.5);
        if (activeVocabulary.length === 0) {
            activeVocabulary = [{en: "Select a Pack", ru: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö"}];
        }
    }

    // --- –õ–û–ì–ò–ö–ê –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ---
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('modeSpeak').className = mode === 'speak' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('modeQuiz').className = mode === 'quiz' ? 'mode-btn active' : 'mode-btn';
        
        document.getElementById('speakContainer').className = mode === 'speak' ? '' : 'hidden';
        document.getElementById('quizContainer').className = mode === 'quiz' ? '' : 'hidden';
        
        loadWord(currentIndex); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–ª–æ–≤–æ –ø–æ–¥ —Ä–µ–∂–∏–º
    }

    function loadWord(index) {
        currentIndex = index;
        const item = activeVocabulary[currentIndex];
        const statusEl = document.getElementById('statusMessage');
        statusEl.innerText = "";
        statusEl.className = "status";

        const mainEl = document.getElementById('mainWordDisplay');
        const subEl = document.getElementById('subWordDisplay');

        if (currentMode === 'speak') {
            mainEl.innerText = item.en;
            subEl.innerText = item.ru;
            // –í —Ä–µ–∂–∏–º–µ –≥–æ–≤–æ—Ä–µ–Ω–∏—è —Å—Ä–∞–∑—É –ù–ï –ø—Ä–æ–∏–∑–Ω–æ—Å–∏–º (–∂–¥–µ–º –¥–µ–π—Å—Ç–≤–∏–π)
        } else {
            // –†–µ–∂–∏–º —Ç–µ—Å—Ç–∞
            mainEl.innerText = "???"; 
            subEl.innerText = "–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è —ç—Ç–æ —Å–ª–æ–≤–æ?";
            generateQuizButtons(item);
            // –í —Ç–µ—Å—Ç–µ –ø–æ–ª–µ–∑–Ω–æ —Å—Ä–∞–∑—É –æ–∑–≤—É—á–∏—Ç—å —Å–ª–æ–≤–æ
            speakEnglish(item.en);
        }
        
        const progress = ((index + 1) / activeVocabulary.length) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
        document.getElementById('debugCounter').innerText = globalWordCounter;
    }
    // --- –ê–£–î–ò–û ---
	function playCurrentWord(playRussianToo = false) {
        const item = activeVocabulary[currentIndex];
        
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π (–≤–Ω—É—Ç—Ä–∏ speakEnglish –µ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏)
        speakEnglish(item.en); 

        // –°—Ä–∞–∑—É –∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å —Ä—É—Å—Å–∫–∏–π. 
        // –ú—ã —É–±—Ä–∞–ª–∏ callback (—Å—Ç—Ä–µ–ª–æ—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é), –ø–æ—ç—Ç–æ–º—É –ø–∞—É–∑—ã –Ω–µ –±—É–¥–µ—Ç.
        if (playRussianToo) {
            speakRussian(item.ru);
        }
    }

    function speakEnglish(text, callback) {
        if (synth.speaking) synth.cancel();

        // –õ–û–ì–ò–ö–ê –®–£–¢–ö–ò: –ï—Å–ª–∏ —Å—á–µ—Ç—á–∏–∫ –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 20, –≤—Å—Ç–∞–≤–ª—è–µ–º —à—É—Ç–∫—É –ø–µ—Ä–µ–¥ —Å–ª–æ–≤–æ–º
        if (globalWordCounter > 0 && globalWordCounter % 20 === 0) {
            const jokeUtter = new SpeechSynthesisUtterance("–ö–∞–∫ —Ç–µ–±–µ —Å –º—É–∂–µ–º –ø–æ–≤–µ–∑–ª–æ, –¢–∞–Ω—è");
            jokeUtter.lang = 'ru-RU';
            jokeUtter.rate = 1.1;
            
            const wordUtter = new SpeechSynthesisUtterance(text);
            wordUtter.lang = 'en-US';
            wordUtter.rate = 0.9;
            if (callback) wordUtter.onend = callback;

            // –û—á–µ—Ä–µ–¥—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            synth.speak(jokeUtter);
            synth.speak(wordUtter);
        } else {
            // –û–±—ã—á–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-US';
            utter.rate = 0.9;
            if (callback) utter.onend = callback;
            synth.speak(utter);
        }
    }

    function speakRussian(text) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'ru-RU'; 
        utter.rate = 1.0;
        synth.speak(utter);
    }

    // --- –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï (–†–µ–∂–∏–º 1) ---
    function startListening() {
        if (!recognition) {
            alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ."); 
            return;
        }
        recognition.start();
    }

    function handleSpeechResult(event) {
        const spoken = event.results[0][0].transcript.toLowerCase();
        const target = activeVocabulary[currentIndex].en.toLowerCase();
        
        // –£–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
        const cleanSpoken = spoken.replace(/[^a-z]/g, '');
        const cleanTarget = target.replace(/[^a-z]/g, '');

        if (cleanSpoken.includes(cleanTarget) || cleanTarget.includes(cleanSpoken)) {
            updateStatus(`–í–µ—Ä–Ω–æ! (${spoken})`, "success");
        } else {
            updateStatus(`–£—Å–ª—ã—à–∞–ª: ${spoken}`, "error");
        }
    }

    // --- –í–ò–ö–¢–û–†–ò–ù–ê (–†–µ–∂–∏–º 2) ---
    function generateQuizButtons(correctItem) {
        const container = document.getElementById('quizOptions');
        container.innerHTML = '';
        
        // –ë–µ—Ä–µ–º 2 –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞
        let options = [correctItem];
        let pool = activeVocabulary.filter(w => w.en !== correctItem.en);
        
        if (pool.length < 2) pool = pool.concat(pool); // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–∞–ª–æ–≥–æ –∫–æ–ª-–≤–∞ —Å–ª–æ–≤

        pool.sort(() => Math.random() - 0.5);
        options.push(pool[0]);
        if (pool[1]) options.push(pool[1]);

        options.sort(() => Math.random() - 0.5);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn quiz-option';
            btn.innerText = opt.ru;
            btn.onclick = () => checkQuizAnswer(btn, opt, correctItem);
            container.appendChild(btn);
        });
    }

    function checkQuizAnswer(btn, selected, correct) {
        if (selected.en === correct.en) {
            btn.classList.add('correct');
            document.getElementById('mainWordDisplay').innerText = correct.en;
            updateStatus("–ü—Ä–∞–≤–∏–ª—å–Ω–æ!", "success");
        } else {
            btn.classList.add('wrong');
            updateStatus("–ù–µ —Å–æ–≤—Å–µ–º...", "error");
        }
    }

    // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
    function nextWord() {
        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ª–æ–≤—É
        globalWordCounter++;
        
        let newIndex = currentIndex + 1;
        if (newIndex >= activeVocabulary.length) newIndex = 0;
        loadWord(newIndex);
    }

    function updateStatus(text, type) {
        const el = document.getElementById('statusMessage');
        el.innerText = text;
        el.className = "status " + type;
    }

    // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
    function toggleSettings() {
        const modal = document.getElementById('settingsModal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function renderSettings() {
        const list = document.getElementById('categoriesList');
        list.innerHTML = '';
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏, —á—Ç–æ–±—ã pack1, pack2 —à–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
        const sortedKeys = Object.keys(wordCollections).sort((a,b) => {
            return parseInt(a.replace('pack','')) - parseInt(b.replace('pack',''));
        });

        for (let key of sortedKeys) {
            const cat = wordCollections[key];
            const div = document.createElement('div');
            div.className = 'category-item';
            div.innerHTML = `
                <span>${cat.name}</span>
                <label class="switch">
                    <input type="checkbox" id="cat_${key}" ${cat.active ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            `;
            list.appendChild(div);
        }
    }

    function saveSettings() {
        for (let key in wordCollections) {
            const checkbox = document.getElementById(`cat_${key}`);
            wordCollections[key].active = checkbox.checked;
        }
        buildVocabulary();
        toggleSettings();
        globalWordCounter = 0; // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        loadWord(0);
    }

    window.onload = init;
</script>

</body>
</html>